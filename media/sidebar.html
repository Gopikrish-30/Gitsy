<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src {{cspSource}} https:; script-src {{cspSource}} 'unsafe-inline'; style-src {{cspSource}} 'unsafe-inline'; font-src {{cspSource}};">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-color: var(--vscode-sideBar-background);
            --card-bg: var(--vscode-editor-background);
            --border-color: var(--vscode-widget-border);
            --text-primary: var(--vscode-foreground);
            --text-secondary: var(--vscode-descriptionForeground);
            --accent: var(--vscode-button-background);
            --accent-hover: var(--vscode-button-hoverBackground);
            --hover-bg: var(--vscode-list-hoverBackground);
            --input-bg: var(--vscode-input-background);
            --input-border: var(--vscode-input-border);
            --button-blue: #007acc;
            --button-blue-hover: #0062a3;
            --success: #238636;
            --error: #d73a49;
        }

        body {
            font-family: var(--vscode-font-family);
            padding: 0;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-size: 13px;
        }

        /* --- Tabs --- */
        .tab-nav {
            display: flex;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tab-link {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 2px solid transparent;
            font-size: 12px;
            text-transform: uppercase;
        }

        .tab-link:hover {
            color: var(--text-primary);
        }

        .tab-link.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
            font-weight: 600;
        }

        /* --- Content Layout --- */
        .tab-content {
            display: none;
            padding: 16px;
            animation: fadeIn 0.2s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Profile Header --- */
        .profile-card {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            overflow: hidden;
        }

        .profile-name {
            font-weight: 600;
            display: block;
        }

        .profile-email {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profile-settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .profile-settings-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }


        /* --- Repository Info Card --- */
        .repo-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .repo-header {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .repo-header-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .repo-header-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--accent);
            color: white;
            border-radius: 10px;
        }

        .repo-row {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .repo-row:last-child {
            border-bottom: none;
        }

        .repo-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .repo-value {
            font-family: monospace;
            font-size: 0.95em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-btn {
            cursor: pointer;
            opacity: 0.5;
            font-size: 1.1em;
        }

        .copy-btn:hover {
            opacity: 1;
        }


        /* --- File Status List --- */
        .status-section {
            margin-bottom: 20px;
        }

        .section-header {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .file-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 6px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            font-size: 12px;
            font-family: monospace;
            border-bottom: 1px solid var(--border-color);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background-color: var(--hover-bg);
        }

        .file-path {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .file-status {
            font-weight: bold;
        }

        /* Modified */
        .status-M {
            color: #e2c08d;
        }

        /* Added */
        .status-A {
            color: #73c991;
        }

        /* Deleted */
        .status-D {
            color: #f14c4c;
        }

        /* Unmerged/Conflict */
        .status-U {
            color: #ff6b6b;
        }

        /* Untracked */
        .status-\? {
            color: #ffa500;
        }

        /* Renamed */
        .status-R {
            color: #82aaff;
        }

        /* Copied */
        .status-C {
            color: #c792ea;
        }

        /* Unsaved changes indicator */
        .file-status::after {
            content: attr(data-unsaved);
            color: #ffa500;
            font-weight: bold;
            margin-left: 4px;
        }


        /* --- Action Buttons --- */
        .primary-btn {
            width: 100%;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s, opacity 0.2s;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .primary-btn:hover {
            background-color: var(--accent-hover);
        }

        .primary-btn:disabled,
        .secondary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }

        .secondary-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background-color: var(--hover-bg);
            border-color: var(--accent);
        }

        .btn-icon {
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* --- Setup View (Clean & Professional) --- */
        .setup-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 40px 24px;
            text-align: center;
            box-sizing: border-box;
            background: var(--bg-color);
        }

        .setup-logo-container {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #007acc 0%, #0098ff 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 24px rgba(0, 122, 204, 0.25);
            margin-bottom: 24px;
        }

        .setup-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
            color: var(--text-primary);
        }

        .setup-desc {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 13px;
            line-height: 1.6;
            max-width: 280px;
        }

        .auth-btn {
            width: 100%;
            max-width: 280px;
            background-color: #24292e;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-btn:hover {
            background-color: #2f363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .auth-btn svg {
            fill: white;
        }

        .auth-help-text {
            margin-top: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 280px;
            line-height: 1.5;
        }

        .auth-help-text.visible {
            opacity: 0.7;
        }

        .auth-footer {
            margin-top: 32px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 6px;
        }


        /* --- Forms --- */
        .input {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            padding: 8px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 12px;
            box-sizing: border-box;
            outline: none;
            font-family: inherit;
        }

        .input:focus {
            border-color: var(--accent);
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        .close-modal {
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* --- Alerts & PRs --- */
        .alert-banner {
            background-color: #d29922;
            /* Warning Orange */
            color: #24292f;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease;
        }

        .pr-item {
            display: flex;
            flex-direction: column;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .pr-item:last-child {
            border-bottom: none;
        }

        .pr-item:hover {
            background-color: var(--hover-bg);
        }

        .pr-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .pr-meta {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pr-actions {
            display: flex;
            gap: 4px;
        }

        .pr-action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pr-action-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        .ci-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
    </style>
    <style>
        /* --- Antigravity UI Theme --- */
        :root {
            --bg-color: #0d1117;
            /* VS Code dark dim */
            --card-bg: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #1f6feb;
            --accent-hover: #388bfd;
            --hover-bg: #21262d;
            --input-bg: #0d1117;
            --user-bubble-bg: #21262d;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- Chat Layout --- */
        #chat {
            height: 100vh;
            /* display: flex;  <-- Removed permanent flex */
            /* flex-direction: column; <-- Moved to .active */
            overflow: hidden !important;
            padding: 0;
            background: var(--bg-color);
        }

        /* Only show as flex when active tab */
        #chat.active {
            display: flex !important;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* --- Message Cards --- */
        .message-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 100%;
            animation: fadeIn 0.2s ease;
        }

        .message-row.user {
            align-items: flex-end;
        }

        .message-row.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13.5px;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 90%;
        }

        .message-bubble.user {
            background-color: var(--user-bubble-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-bubble.assistant {
            background-color: transparent;
            /* Agent text blends w/ bg usually, or card */
            padding-left: 0;
            color: var(--text-primary);
        }

        /* Agent Card (for specific blocks like 'Thought', 'Result') */
        .agent-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .agent-card-title {
            font-size: 0.85em;
            color: var(--accent);
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- Input Area --- */
        .chat-input-area {
            position: relative;
            flex-shrink: 0;
            padding: 12px 12px 24px 12px;
            /* Reduced specific padding */
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 8px;
            /* Reduced gap */
            z-index: 10;
            box-sizing: border-box;
            /* Critical for sizing */
            width: 100%;
        }

        .icon-btn {
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            /* Prevent squishing */
        }

        .icon-btn:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }

        .chat-input-wrapper {
            flex: 1;
            min-width: 0;
            /* Allow flex item to shrink below content size */
            background: #161b22;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 10px;
            /* Tighter padding inside */
            display: flex;
            align-items: flex-end;
            gap: 6px;
            transition: border-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
        }

        #chat-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            /* Allow shrinking */
            font-family: inherit;
            resize: none;
            outline: none;
            height: 20px;
            min-height: 20px;
            max-height: 150px;
            font-size: 13.5px;
            line-height: 1.5;
            padding: 0;
            margin-bottom: 2px;
        }

        .send-btn-mini {
            background: var(--accent);
            color: white;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-btn-mini:hover {
            background: var(--accent-hover);
        }

        .chat-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            opacity: 0.4;
            color: var(--text-secondary);
            padding-bottom: 40px;
            text-align: center;
            padding-left: 20px;
            padding-right: 20px;
        }
    </style>
</head>

<body>

    <!-- Loading State (shown until auth is determined) -->
    <div id="loading-view"
        style="display:flex; align-items:center; justify-content:center; height:100vh; flex-direction:column; gap:12px;">
        <div
            style="width:28px; height:28px; border:3px solid var(--text-secondary); border-top-color:var(--button-blue); border-radius:50%; animation:spin 0.8s linear infinite;">
        </div>
        <span style="color:var(--text-secondary); font-size:0.85em;">Loading Gitsy...</span>
    </div>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Setup View - Redesigned -->
    <div id="setup-view" class="setup-container" style="display:none;">
        <!-- Logo + Brand -->
        <div style="display:flex;flex-direction:column;align-items:center;padding:28px 0 16px;">
            <img src="{{logoUri}}" alt="Gitsy" style="width:80px;height:80px;border-radius:16px;" />
            <div style="font-size:1.5em;font-weight:800;margin-top:10px;letter-spacing:-0.5px;">Gitsy</div>
            <div
                style="font-size:11px;color:var(--text-secondary);margin-top:4px;letter-spacing:0.5px;text-transform:uppercase;">
                Smart Git &#183; AI Pre-flight</div>
        </div>

        <!-- Feature pills -->
        <div style="display:flex;flex-direction:column;gap:8px;padding:0 16px 20px;">
            <div
                style="display:flex;align-items:center;gap:10px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:9px 12px;">
                <span style="font-size:16px;">&#128640;</span>
                <div>
                    <div style="font-size:11.5px;font-weight:600;">Fast Push</div>
                    <div style="font-size:10px;color:var(--text-secondary);">Stage, commit &amp; push in one click</div>
                </div>
            </div>
            <div
                style="display:flex;align-items:center;gap:10px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:9px 12px;">
                <span style="font-size:16px;">&#129302;</span>
                <div>
                    <div style="font-size:11.5px;font-weight:600;">AI Pre-flight <span
                            style="font-size:9px;background:rgba(31,111,235,0.15);color:#388bfd;padding:1px 5px;border-radius:8px;font-weight:700;margin-left:4px;">VS
                            Code Copilot</span></div>
                    <div style="font-size:10px;color:var(--text-secondary);">Checks secrets, code quality &amp; more
                        before every push</div>
                </div>
            </div>
            <div
                style="display:flex;align-items:center;gap:10px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:9px 12px;">
                <span style="font-size:16px;">&#9889;</span>
                <div>
                    <div style="font-size:11.5px;font-weight:600;">Flow Log</div>
                    <div style="font-size:10px;color:var(--text-secondary);">Full session history of all git operations
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth button -->
        <div style="padding:0 16px 14px;">
            <button class="auth-btn" onclick="connectGitHub()"
                style="width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 0;font-size:13px;">
                <svg height="18" viewBox="0 0 16 16" version="1.1" width="18" aria-hidden="true" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
                Connect with GitHub
            </button>
        </div>

        <div id="auth-help" class="auth-help-text" style="text-align:center;font-size:11px;padding-bottom:8px;"></div>

        <div
            style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px 20px;border-top:1px solid var(--border-color);">
            <span style="font-size:13px;">&#128274;</span>
            <span style="font-size:10px;color:var(--text-secondary);">Secure OAuth 2.0 &#183; Code stays private &#183;
                AI via VS Code Copilot</span>
        </div>
    </div>

    <span style="color:var(--text-secondary); font-size:0.85em;">Loading Gitsy...</span>
    </div>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Setup View -->
    <div id="setup-view" class="setup-container" style="display:none;">
        <div class="setup-logo-container"
            style="display: flex; flex-direction: column; align-items: center; background: none; box-shadow: none; width: auto; height: auto;">
            <img src="{{logoUri}}" alt="Gitsy" style="width: 200px; height: 200px; margin-bottom: 0px;" />
            <div class="setup-title" style="margin-top: -10px; font-size: 1.25em;">Gitsy</div>
        </div>
        <div class="setup-desc">
            Smart Git management for modern developers. Connect your GitHub account to get started.
        </div>

        <button class="auth-btn" onclick="connectGitHub()">
            <svg height="20" viewBox="0 0 16 16" version="1.1" width="20" aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
            Connect with GitHub
        </button>

        <div id="auth-help" class="auth-help-text">
            Secure OAuth 2.0 authentication
        </div>

        <div class="auth-footer">
            <span>üîí</span>
            <span>Your data stays secure and private</span>
        </div>
    </div>



    <!-- Main View -->
    <div id="main-view" style="display: none;">
        <div class="tab-nav">
            <button class="tab-link active" onclick="openTab('dashboard')">Dashboard</button>
            <button class="tab-link" onclick="openTab('flow')">‚ö° Flow</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">

            <!-- Alerts -->
            <div id="state-alerts"></div>

            <!-- Profile -->
            <div class="profile-card">
                <div class="profile-avatar" id="user-avatar">...</div>
                <div class="profile-info">
                    <span class="profile-name" id="user-name">Loading...</span>
                    <span class="profile-email" id="user-email">Loading...</span>
                </div>
                <button class="profile-settings-btn" onclick="openTab('profile')" title="Settings">‚öôÔ∏è</button>
            </div>

            <!-- Remote Repo Section -->
            <div class="section-header" style="margin-top: 20px;">Remote Repo</div>
            <div class="repo-card" style="padding: 16px;">
                <div style="margin-bottom: 12px;">
                    <span class="repo-label" style="display:block; margin-bottom:4px;">Repo Name</span>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="repo-name" style="font-size:1.1em; font-weight:600;">Loading...</span>
                        <span class="copy-btn" title="Copy Name" onclick="copyToClipboard('repo-name')">‚ùê</span>
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <span class="repo-label" style="display:block; margin-bottom:4px;">Repo URL</span>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="repo-path"
                            style="font-family:monospace; font-size:0.9em; word-break:break-all; white-space:normal; display:block; padding-right:8px;">...</span>
                        <span class="copy-btn" title="Copy URL" onclick="copyToClipboard('repo-path')">‚ùê</span>
                    </div>
                </div>

                <div>
                    <span class="repo-label" style="display:block; margin-bottom:4px;">Lastly Pushed</span>
                    <span id="repo-last-commit" style="font-family:monospace;">-</span>
                </div>
            </div>

            <!-- Branch & Status Grid -->
            <div class="action-grid">
                <div class="secondary-btn"
                    style="align-items: center; justify-content: center; cursor: default; height: 60px;">
                    <span class="repo-label" style="font-size: 0.7em; text-transform: uppercase;">Current
                        Branch</span>
                    <span id="stat-branch"
                        style="font-size: 1.1em; font-weight: 700; color: var(--button-blue);">-</span>
                </div>
                <div class="secondary-btn"
                    style="align-items: center; justify-content: center; cursor: default; height: 60px;">
                    <span class="repo-label" style="font-size: 0.7em; text-transform: uppercase;">Repo Status</span>
                    <span id="stat-status"
                        style="font-size: 1.1em; font-weight: 700; color: var(--button-blue); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">-</span>
                </div>
            </div>

            <!-- Pull Requests -->
            <div class="status-section" id="pr-section" style="display:none;">
                <div class="section-header">Pull Requests</div>
                <div class="file-list" id="pr-list" style="max-height: 200px;"></div>
            </div>

            <!-- File Status -->
            <div class="status-section">
                <div class="section-header">File Status</div>
                <div class="file-list" id="repo-status-list">
                    <div style="padding:10px; color:var(--text-secondary); text-align:center;">Loading...</div>
                </div>
            </div>

            <!-- Fast Push -->
            <button class="primary-btn" onclick="openFastPushModal()">
                <span>‚ö°</span> Fast Push
            </button>

            <!-- Sync Actions -->
            <div class="section-header">Sync</div>
            <div class="action-grid">
                <button class="secondary-btn" onclick="gitAction('pull')">
                    <span class="btn-icon">‚Üì</span> Pull
                </button>
                <button class="secondary-btn" onclick="gitAction('push')">
                    <span class="btn-icon">‚Üë</span> Push
                </button>
                <button class="secondary-btn" onclick="promptCommit()">
                    <span class="btn-icon">‚óè</span> Commit
                </button>
                <button class="secondary-btn" id="btn-stash" onclick="gitAction('stash')">
                    <span class="btn-icon">‚â°</span> Stash
                </button>
            </div>

            <!-- Branch Actions -->
            <div class="section-header">Branching</div>
            <div class="action-grid">
                <button class="secondary-btn" onclick="promptCreateBranch()">
                    <span class="btn-icon">+</span> New
                </button>
                <button class="secondary-btn" onclick="promptSwitchBranch()">
                    <span class="btn-icon">‚áÑ</span> Switch
                </button>
                <button class="secondary-btn" onclick="promptMergeBranch()">
                    <span class="btn-icon">‚ëÉ</span> Merge
                </button>
                <button class="secondary-btn" onclick="promptDeleteBranch()">
                    <span class="btn-icon">üóë</span> Delete
                </button>
            </div>



        </div>

        <!-- Profile/Settings Tab -->
        <div id="profile" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="secondary-btn" style="display:inline-block; width:auto; padding: 4px 8px;"
                    onclick="openTab('dashboard')">‚Üê Back</button>
            </div>

            <div class="profile-card">
                <div class="profile-avatar" id="profile-avatar">?</div>
                <div class="profile-info">
                    <span class="profile-name" id="profile-name">Guest</span>
                </div>
            </div>

            <!-- Account Section -->
            <div class="section-header" style="margin-top:20px;">Account</div>
            <p style="font-size:0.85em; color:var(--text-secondary); margin:8px 0 16px 0;">Authenticated via GitHub
                OAuth. Your token is managed securely by VS Code.</p>

            <div style="border-top:1px solid var(--border-color); padding-top:20px;">
                <button class="primary-btn" style="background-color: var(--error);"
                    onclick="logoutGitHub()">Logout</button>
            </div>
        </div>

    </div>

    <!-- Modals (Fast Push) -->
    <div id="fast-push-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ö° Fast Push Setup</span>
                <span class="close-modal" onclick="closeFastPushModal()">√ó</span>
            </div>

            <div class="form-group">
                <label class="form-label" style="font-weight: 600;">Destination</label>
                <div class="radio-group" style="margin-top: 8px;">
                    <label class="radio-label">
                        <input type="radio" name="repo-type" value="existing" checked onchange="toggleRepoInputs()">
                        Existing Remote
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="repo-type" value="new" onchange="toggleRepoInputs()">
                        Create New Repo
                    </label>
                </div>
            </div>

            <!-- Existing Repo Flow -->
            <div id="existing-repo-input" class="form-group">
                <label class="form-label">Repository</label>
                <select id="fp-repo-select" class="input" onchange="updateRepoUrlFromSelect()">
                    <option value="">Loading...</option>
                </select>
                <input type="text" id="fp-repo-url" class="input" placeholder="Or paste Git URL manually..."
                    style="margin-top: 5px; display:none;">
                <div style="font-size:10px; color:var(--text-secondary); text-align:right; margin-top:2px;">
                    <a href="#" onclick="document.getElementById('fp-repo-url').style.display='block'; return false;"
                        style="color:var(--text-secondary); text-decoration:none;">Enter URL manually</a>
                </div>
            </div>

            <!-- New Repo Flow -->
            <div id="new-repo-input" class="form-group" style="display: none;">
                <label class="form-label">New Repository Name</label>
                <input type="text" id="fp-new-repo-name" class="input" placeholder="e.g. my-project">

                <label class="form-label">Description (optional)</label>
                <input type="text" id="fp-new-repo-desc" class="input" placeholder="Project description">

                <label class="form-label">Visibility</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="repo-visibility" value="private" checked>
                        üîí Private
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="repo-visibility" value="public">
                        üåç Public
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <!-- Select for existing -->
                    <select id="fp-branch-select" class="input" style="flex:1;">
                        <option value="main">main</option>
                        <option value="master">master</option>
                    </select>

                    <!-- Input for new -->
                    <input type="text" id="fp-new-branch-input" class="input" style="display: none; flex:1;"
                        placeholder="New branch name (e.g. feature/xyz)">

                    <!-- Actions -->
                    <button id="btn-add-branch" class="secondary-btn"
                        style="width:auto; padding:0 10px; height:100%; justify-content:center;"
                        onclick="showNewBranchInput()" title="Create New Branch">
                        +
                    </button>
                    <button id="btn-cancel-branch" class="secondary-btn"
                        style="width:auto; padding:0 10px; height:100%; justify-content:center; display:none;"
                        onclick="cancelNewBranchInput()" title="Cancel New Branch">
                        √ó
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Commit Message</label>
                <input type="text" id="fp-message" class="input" value="Fast Push: Auto-commit">
            </div>

            <button class="primary-btn" onclick="submitFastPush()">üöÄ Push Everything</button>
        </div>
    </div>

    <script nonce="{{nonce}}">
        const vscode = acquireVsCodeApi();

        window.addEventListener('DOMContentLoaded', () => {
            vscode.postMessage({ type: 'get-auth-state' });
        });

        /* --- UI Helpers --- */
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Highlight tab button
            const btns = document.querySelectorAll('.tab-link');
            btns.forEach(btn => {
                if (btn.innerText.toLowerCase().includes(tabName)) {
                    btn.classList.add('active');
                }
            });

        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const text = el.innerText;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    vscode.postMessage({ type: 'onInfo', value: 'Copied!' });
                }).catch(() => {
                    vscode.postMessage({ type: 'onError', value: 'Failed to copy' });
                });
            } else {
                // Fallback for older environments
                const area = document.createElement('textarea');
                area.value = text;
                area.style.position = 'fixed';
                area.style.opacity = '0';
                document.body.appendChild(area);
                area.select();
                document.execCommand('copy');
                document.body.removeChild(area);
                vscode.postMessage({ type: 'onInfo', value: 'Copied!' });
            }
        }

        /* --- Actions --- */
        function connectGitHub() { vscode.postMessage({ type: 'login-github' }); }
        function logoutGitHub() { vscode.postMessage({ type: 'logout-github' }); }
        function refreshStats() { vscode.postMessage({ type: 'refresh-stats' }); }

        function setDashboardButtonsDisabled(disabled) {
            document.querySelectorAll('#dashboard .action-grid .secondary-btn').forEach(btn => {
                btn.disabled = disabled;
            });
        }

        function gitAction(action, payload = {}) {
            console.log('[Gitsy WebView] gitAction called:', action);
            setDashboardButtonsDisabled(true);
            // Safety: re-enable buttons after 90 seconds in case extension doesn't respond
            setTimeout(() => setDashboardButtonsDisabled(false), 90000);
            vscode.postMessage({ type: 'git-action', action, payload });
        }
        function promptCommit() { gitAction('commit'); }
        function promptCreateBranch() { gitAction('create-branch'); }
        function promptSwitchBranch() { gitAction('switch-branch'); }
        function promptMergeBranch() { gitAction('merge-branch'); }
        function promptDeleteBranch() { gitAction('delete-branch'); }

        /* --- Fast Push Modal Logic --- */
        function openFastPushModal() {
            document.getElementById('fast-push-modal').style.display = 'flex';
            vscode.postMessage({ type: 'get-repos' });

            // Pre-fill current remote if available
            const currentRemote = document.getElementById('repo-path').innerText;
            if (currentRemote && currentRemote !== '...' && currentRemote !== 'No origin') {
                document.getElementById('fp-repo-url').value = currentRemote;
                // Make manual input visible if pre-filled
                document.getElementById('fp-repo-url').style.display = 'block';
                // Fetch branches for this remote
                vscode.postMessage({ type: 'get-remote-branches', value: currentRemote });
            }
        }

        function closeFastPushModal() {
            document.getElementById('fast-push-modal').style.display = 'none';
        }




        function toggleRepoInputs() {
            const type = document.querySelector('input[name="repo-type"]:checked').value;
            document.getElementById('existing-repo-input').style.display = type === 'existing' ? 'block' : 'none';
            document.getElementById('new-repo-input').style.display = type === 'new' ? 'block' : 'none';
        }

        function showNewBranchInput() {
            document.getElementById('fp-branch-select').style.display = 'none';
            document.getElementById('btn-add-branch').style.display = 'none';

            document.getElementById('fp-new-branch-input').style.display = 'block';
            document.getElementById('btn-cancel-branch').style.display = 'flex'; // secondary-btn uses flex

            document.getElementById('fp-new-branch-input').focus();
        }

        function cancelNewBranchInput() {
            document.getElementById('fp-new-branch-input').value = ''; // clear
            document.getElementById('fp-new-branch-input').style.display = 'none';
            document.getElementById('btn-cancel-branch').style.display = 'none';

            document.getElementById('fp-branch-select').style.display = 'block';
            document.getElementById('btn-add-branch').style.display = 'flex';
        }

        function submitFastPush() {
            const repoType = document.querySelector('input[name="repo-type"]:checked').value;
            let repoUrl = document.getElementById('fp-repo-select').value;
            const manualUrl = document.getElementById('fp-repo-url').value;

            // Setup Repo URL
            if (repoType === 'existing') {
                if (manualUrl && document.getElementById('fp-repo-url').style.display !== 'none') {
                    repoUrl = manualUrl;
                }
                if (!repoUrl) {
                    vscode.postMessage({ type: 'error', value: 'Please select a repository or enter a URL.' });
                    return;
                }
            }

            // New Repo Details
            const newRepoName = document.getElementById('fp-new-repo-name').value;
            const newRepoDesc = document.getElementById('fp-new-repo-desc').value;
            const visibility = document.querySelector('input[name="repo-visibility"]:checked').value;
            const newRepoPrivate = visibility === 'private';

            if (repoType === 'new' && !newRepoName) {
                vscode.postMessage({ type: 'error', value: 'Please enter a name for the new repository.' });
                return;
            }

            let branch = document.getElementById('fp-branch-select').value;
            const newBranchInput = document.getElementById('fp-new-branch-input');
            if (newBranchInput.style.display !== 'none' && newBranchInput.value.trim()) {
                branch = newBranchInput.value.trim();
            }

            // Validate branch name ‚Äî reject loading placeholders and invalid chars
            if (!branch || branch === 'Loading...' || branch.startsWith('Loading')) {
                branch = 'main';
            }
            if (!/^[a-zA-Z0-9_\/-]+$/.test(branch)) {
                vscode.postMessage({ type: 'error', value: 'Invalid branch name: "' + branch + '". Use only alphanumeric, _, /, -' });
                return;
            }

            const message = document.getElementById('fp-message').value;

            vscode.postMessage({
                type: 'fast-push-execute',
                payload: {
                    repoType,
                    repoUrl,
                    newRepoName,
                    newRepoDesc,
                    newRepoPrivate,
                    branch,
                    message
                }
            });
            closeFastPushModal();
        }



        function showPatLogin() {
            // PAT login removed ‚Äî use GitHub OAuth instead
            connectGitHub();
        }
        function showSetup() {
            document.getElementById('setup-view').style.display = 'flex';
            document.getElementById('main-view').style.display = 'none';
        }


        function saveSettings() {
            // Settings managed via OAuth ‚Äî nothing to save manually
            vscode.postMessage({ type: 'onInfo', value: 'Settings managed via GitHub OAuth.' });
        }

        /* --- Event Listener --- */
        window.addEventListener('message', event => {
            const message = event.data;
            const type = message.type;
            const value = message.value;
            console.log('[Gitsy WebView] Message from extension:', type);

            switch (type) {
                case 'set-loading':
                    const btn = document.querySelector('#setup-view .auth-btn');
                    const helpText = document.getElementById('auth-help');
                    if (btn) {
                        if (value) {
                            btn.innerHTML = '<span>‚è≥</span> Redirecting...';
                            btn.style.opacity = '0.7';
                            btn.style.pointerEvents = 'none';
                            if (helpText) helpText.classList.add('visible');
                        } else {
                            // Restore button content
                            btn.innerHTML = `<svg height="20" viewBox="0 0 16 16" version="1.1" width="20" aria-hidden="true" style="fill:white; margin-right:10px;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> Connect with GitHub`;
                            btn.style.opacity = '1';
                            btn.style.pointerEvents = 'auto';
                            if (helpText) helpText.classList.remove('visible');
                        }
                    }
                    break;
                case 'show-dashboard':
                    document.getElementById('loading-view').style.display = 'none';
                    document.getElementById('setup-view').style.display = 'none';
                    document.getElementById('main-view').style.display = 'block';
                    break;
                case 'show-setup':
                    document.getElementById('loading-view').style.display = 'none';
                    document.getElementById('setup-view').style.display = 'flex';
                    document.getElementById('main-view').style.display = 'none';
                    break;
                case 'update-user-quick':
                    // Instant profile display ‚Äî shows user info immediately without waiting for full stats
                    if (value) {
                        const avatarEl = document.getElementById('user-avatar');
                        const nameEl = document.getElementById('user-name');
                        const emailEl = document.getElementById('user-email');
                        if (nameEl && value.name) nameEl.innerText = value.name;
                        if (emailEl) emailEl.innerText = value.email || 'Authenticated';
                        if (avatarEl && value.avatar) {
                            avatarEl.innerText = '';
                            avatarEl.style.backgroundImage = "url('" + value.avatar + "')";
                            avatarEl.style.backgroundSize = 'cover';
                            avatarEl.style.backgroundPosition = 'center';
                        } else if (avatarEl && value.name) {
                            avatarEl.innerText = value.name.charAt(0).toUpperCase();
                        } else if (avatarEl && value.login) {
                            avatarEl.innerText = value.login.charAt(0).toUpperCase();
                        }
                    }
                    break;

                case 'update-stats':
                    { const lv = document.getElementById('loading-view'); if (lv) lv.style.display = 'none'; }
                    if (value.repoName) document.getElementById('repo-name').innerText = value.repoName;
                    if (value.remote) document.getElementById('repo-path').innerText = value.remote;
                    if (value.lastCommit) document.getElementById('repo-last-commit').innerText = value.lastCommit;

                    // Branch - with tooltip
                    if (value.branch) {
                        const branchEl = document.getElementById('stat-branch');
                        branchEl.innerText = value.branch;
                        branchEl.title = `Current branch: ${value.branch}`;
                    }

                    if (value.status) {
                        const isDirty = value.status !== 'Clean' && value.status.trim().length > 0;
                        document.getElementById('stat-status').innerText = isDirty ? "Pending Changes" : "Synced";
                        if (!isDirty) {
                            document.getElementById('stat-status').style.color = 'var(--text-secondary)';
                        } else {
                            document.getElementById('stat-status').style.color = 'var(--button-blue)';
                        }
                    }

                    if (value.user) {
                        document.getElementById('user-name').innerText = value.user.name;
                        document.getElementById('user-email').innerText = value.user.email;
                        document.getElementById('profile-name').innerText = value.user.name;

                        // Avatar
                        const avText = value.user.name.charAt(0).toUpperCase();
                        const avEls = [document.getElementById('user-avatar'), document.getElementById('profile-avatar')];
                        avEls.forEach(el => {
                            if (value.user.avatar) {
                                el.innerText = '';
                                el.style.backgroundImage = `url('${value.user.avatar}')`;
                                el.style.backgroundSize = 'cover';
                            } else {
                                el.innerText = avText;
                            }
                        });
                    }

                    // Alerts
                    const alerts = [];
                    if (value.rebaseStatus) alerts.push({ text: value.rebaseStatus, icon: '‚ö†Ô∏è' });
                    if (value.mergeStatus) alerts.push({ text: value.mergeStatus, icon: '‚ö†Ô∏è' });
                    if (value.conflicts && value.conflicts.length > 0) alerts.push({ text: `Conflicts: ${value.conflicts.length} files`, icon: 'üõë' });

                    const alertContainer = document.getElementById('state-alerts');
                    if (alertContainer) {
                        alertContainer.innerHTML = '';
                        alerts.forEach(a => {
                            const d = document.createElement('div');
                            d.className = 'alert-banner';
                            d.innerHTML = `<span>${a.icon}</span> ${a.text}`;
                            alertContainer.appendChild(d);
                        });
                    }

                    // CI Status Badge
                    if (value.commitStatus) {
                        const branchEl = document.getElementById('stat-branch');
                        let color = 'var(--text-secondary)';
                        if (value.commitStatus === 'SUCCESS') color = 'var(--success)';
                        else if (value.commitStatus === 'FAILURE' || value.commitStatus === 'ERROR') color = 'var(--error)';
                        else if (value.commitStatus === 'PENDING') color = '#dbab09';

                        let badge = branchEl.querySelector('.ci-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'ci-badge';
                            branchEl.appendChild(badge);
                        }
                        badge.style.backgroundColor = color;
                        badge.title = `CI Status: ${value.commitStatus}`;
                    }

                    // PRs
                    const prSection = document.getElementById('pr-section');
                    const prList = document.getElementById('pr-list');
                    if (prSection && prList) {
                        if (value.pullRequests && value.pullRequests.length > 0) {
                            prSection.style.display = 'block';
                            prList.innerHTML = '';
                            value.pullRequests.forEach(pr => {
                                const d = document.createElement('div');
                                d.className = 'pr-item';

                                // Build PR item safely (no innerHTML to prevent XSS)
                                const prBody = document.createElement('div');
                                prBody.style.flex = '1';
                                prBody.style.cursor = 'pointer';
                                prBody.addEventListener('click', () => {
                                    vscode.postMessage({ type: 'open-external', value: pr.url });
                                });

                                const prTitle = document.createElement('div');
                                prTitle.className = 'pr-title';
                                prTitle.textContent = '#' + pr.number + ' ' + pr.title;

                                const prMeta = document.createElement('div');
                                prMeta.className = 'pr-meta';
                                const authorSpan = document.createElement('span');
                                authorSpan.textContent = 'by ' + (pr.author ? pr.author.login : 'unknown');
                                const dateSpan = document.createElement('span');
                                dateSpan.textContent = new Date(pr.createdAt).toLocaleDateString();
                                prMeta.appendChild(authorSpan);
                                prMeta.appendChild(dateSpan);

                                prBody.appendChild(prTitle);
                                prBody.appendChild(prMeta);

                                const prActions = document.createElement('div');
                                prActions.className = 'pr-actions';
                                const checkoutBtn = document.createElement('button');
                                checkoutBtn.className = 'pr-action-btn';
                                checkoutBtn.title = 'Checkout Locally';
                                checkoutBtn.textContent = '‚¨áÔ∏è';
                                checkoutBtn.addEventListener('click', () => checkoutPR(pr.number));
                                const mergeBtn = document.createElement('button');
                                mergeBtn.className = 'pr-action-btn';
                                mergeBtn.title = 'Merge PR';
                                mergeBtn.textContent = 'üîÄ';
                                mergeBtn.addEventListener('click', () => mergePR(pr.number));
                                prActions.appendChild(checkoutBtn);
                                prActions.appendChild(mergeBtn);

                                d.appendChild(prBody);
                                d.appendChild(prActions);
                                prList.appendChild(d);
                            });
                        } else {
                            prSection.style.display = 'none';
                        }
                    }

                    // Stash Count
                    const btnStash = document.getElementById('btn-stash');
                    if (btnStash) {
                        if (value.stashList && value.stashList.length > 0) {
                            btnStash.innerHTML = `<span class="btn-icon">‚â°</span> Stash (${value.stashList.length})`;
                        } else {
                            btnStash.innerHTML = `<span class="btn-icon">‚â°</span> Stash`;
                        }
                    }
                    break;
                case 'update-repo-status-list':
                    const list = document.getElementById('repo-status-list');
                    list.innerHTML = '';
                    if (Array.isArray(value) && value.length > 0) {
                        value.forEach(item => {
                            const d = document.createElement('div');
                            d.className = 'file-item';
                            d.style.cursor = 'pointer';

                            // Check if file has unsaved changes (marked with *)
                            const hasUnsaved = item.status.includes('*');
                            const cleanStatus = item.status.replace('*', '');

                            // map status char to class
                            const statusChar = cleanStatus.trim().charAt(0);
                            const statusClass = 'status-' + statusChar;

                            d.innerHTML = `
                                <span class="file-path" title="${item.path}">${item.path}</span>
                                <span class="file-status ${statusClass}" ${hasUnsaved ? 'data-unsaved="*"' : ''}>${cleanStatus}</span>
                            `;

                            // Add click handler to open file
                            d.addEventListener('click', () => {
                                vscode.postMessage({ type: 'open-file', value: item.path });
                            });

                            list.appendChild(d);
                        });
                    } else {
                        list.innerHTML = '<div style="padding:10px; color:var(--text-secondary); text-align:center;">No changes</div>';
                    }
                    break;
                case 'github-connected':
                    // Switch to dashboard
                    document.getElementById('loading-view').style.display = 'none';
                    document.getElementById('setup-view').style.display = 'none';
                    document.getElementById('main-view').style.display = 'block';
                    break;
                case 'error':
                    // Forward backend errors to VS Code notification
                    if (value) {
                        vscode.postMessage({ type: 'onError', value: value });
                    }
                    break;
                case 'action-started':
                    setDashboardButtonsDisabled(true);
                    break;
                case 'action-finished':
                    setDashboardButtonsDisabled(false);
                    break;
                case 'update-repos':
                    const sel = document.getElementById('fp-repo-select');
                    const currentRemote = document.getElementById('repo-path').innerText.trim();
                    sel.innerHTML = '<option value="">Select a repository...</option>';
                    if (Array.isArray(value)) {
                        value.forEach(r => {
                            const opt = document.createElement('option');
                            opt.value = r.clone_url;
                            opt.innerText = r.full_name;

                            // Auto-select if matches current remote
                            // Handle potential .git suffix difference
                            const normalize = (u) => u.replace(/\.git$/, '').toLowerCase();
                            if (currentRemote && normalize(r.clone_url) === normalize(currentRemote)) {
                                opt.selected = true;
                            }

                            sel.appendChild(opt);
                        });
                        // Trigger change event to load branches if one is selected
                        if (sel.value) {
                            updateRepoUrlFromSelect();
                        }
                    }
                    break;
                case 'update-branches':
                    const branchSel = document.getElementById('fp-branch-select');
                    const currentBranch = document.getElementById('stat-branch').innerText.trim();
                    branchSel.innerHTML = '';
                    if (Array.isArray(value) && value.length > 0) {
                        let matchFound = false;
                        value.forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b;
                            opt.innerText = b;
                            if (b === currentBranch) {
                                opt.selected = true;
                                matchFound = true;
                            }
                            branchSel.appendChild(opt);
                        });

                        // If current branch not found (maybe local only), try main/master defaults
                        if (!matchFound) {
                            if (value.includes('main')) branchSel.value = 'main';
                            else if (value.includes('master')) branchSel.value = 'master';
                        }
                    } else {
                        // Fallback
                        branchSel.innerHTML = '<option value="main">main</option><option value="master">master</option>';
                    }
                    break;
            }
        });

        // Update branch list when repo changes
        function updateRepoUrlFromSelect() {
            const select = document.getElementById('fp-repo-select');
            const input = document.getElementById('fp-repo-url');
            if (select && input) {
                const url = select.value;
                input.value = url;

                if (url) {
                    // Show loading in branch select
                    const branchSel = document.getElementById('fp-branch-select');
                    branchSel.innerHTML = '<option value="">Loading...</option>';
                    // Fetch branches
                    vscode.postMessage({ type: 'get-remote-branches', value: url });
                }
            }
        }

        // Trigger for initial load if needed
        const initialRepo = document.getElementById('repo-path');
        if (initialRepo && initialRepo.innerText !== '...') {
            vscode.postMessage({ type: 'get-remote-branches', value: initialRepo.innerText });
        }
        // PR Actions
        function checkoutPR(prNumber) {
            vscode.postMessage({ type: 'pr-checkout', value: { prNumber } });
        }
        function mergePR(prNumber) {
            vscode.postMessage({ type: 'pr-merge', value: { prNumber } });
        }

        // ‚îÄ‚îÄ‚îÄ Flow Tab ‚îÄ‚îÄ‚îÄ
        let flowEntries = [];

        function renderFlowTab(entries) {
            flowEntries = entries || [];
            const container = document.getElementById('flow-list');
            if (!container) { return; }
            if (flowEntries.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--text-secondary);"><div style="font-size:2em;margin-bottom:12px;">&#9889;</div><div style="font-weight:600;margin-bottom:6px;">No operations yet</div><div style="font-size:0.85em;">Git actions you perform via Gitsy will appear here as a session log.</div></div>';
                return;
            }
            const groups = {};
            flowEntries.forEach(entry => {
                const d = new Date(entry.startTime);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                let label = d.toDateString() === today.toDateString() ? 'Today'
                    : d.toDateString() === yesterday.toDateString() ? 'Yesterday'
                        : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                if (!groups[label]) { groups[label] = []; }
                groups[label].push(entry);
            });
            let html = '';
            Object.keys(groups).forEach(label => {
                html += '<div class="flow-date-group">' + label + '</div>';
                groups[label].forEach(entry => { html += renderFlowEntry(entry); });
            });
            container.innerHTML = html;
        }

        function renderFlowEntry(entry) {
            const opIcons = { 'fast-push': '&#128640;', 'push': '&#8679;', 'pull': '&#8681;', 'commit': '&#128221;', 'stash': '&#128203;', 'create-branch': '&#127807;', 'delete-branch': '&#128465;', 'switch-branch': '&#128256;', 'merge': '&#128256;', 'fetch': '&#128260;', 'rebase': '&#8617;' };
            const icon = opIcons[entry.operation] || '&#9889;';
            const statusClass = { running: 'flow-running', success: 'flow-success', failed: 'flow-failed', cancelled: 'flow-cancelled' }[entry.status] || 'flow-running';
            const statusIcon = { running: '&#9203;', success: '&#9989;', failed: '&#10060;', cancelled: '&#8856;' }[entry.status] || '&#9203;';
            const duration = entry.durationMs ? (entry.durationMs / 1000).toFixed(1) + 's' : '';
            const relTime = timeAgo(entry.startTime);
            let preflightBadge = '';
            if (entry.preflightStatus === 'passed') { preflightBadge = '<span class="preflight-badge preflight-pass">AI &#10003;</span>'; }
            else if (entry.preflightStatus === 'failed') { preflightBadge = '<span class="preflight-badge preflight-warn">AI &#9888;</span>'; }
            const errStr = entry.error ? '<div class="flow-entry-error">' + escHtml(entry.error.substring(0, 120)) + '</div>' : '';
            return '<div class="flow-entry ' + statusClass + '"><div class="flow-entry-header"><span class="flow-op-icon">' + icon + '</span><span class="flow-op-name">' + escHtml(entry.operation) + '</span>' + preflightBadge + '<span class="flow-entry-status">' + statusIcon + '</span></div><div class="flow-entry-details">' + escHtml(entry.details) + '</div><div class="flow-entry-meta"><span>' + (entry.branch ? '&#8887; ' + escHtml(entry.branch) : '') + '</span><span>' + (duration ? duration + ' &middot; ' : '') + relTime + '</span></div>' + errStr + '</div>';
        }

        function timeAgo(ts) {
            const diff = Date.now() - ts;
            if (diff < 60000) { return Math.round(diff / 1000) + 's ago'; }
            if (diff < 3600000) { return Math.round(diff / 60000) + ' min ago'; }
            if (diff < 86400000) { return Math.round(diff / 3600000) + 'h ago'; }
            return Math.round(diff / 86400000) + 'd ago';
        }

        function escHtml(s) {
            if (!s) { return ''; }
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Handle extension messages for Flow tab
        window.addEventListener('message', function (evt) {
            const msg = evt.data;
            if (!msg) { return; }

            // Flow list updates ‚Äî also sync the in-memory flowEntries so 30s interval doesn't re-render stale data
            if (msg.type === 'update-flow') { flowEntries = msg.value || []; renderFlowTab(flowEntries); }

            // Show AI checking status in Flow header
            if (msg.type === 'ai-preflight-start') {
                const el = document.getElementById('flow-ai-status');
                if (el) { el.innerHTML = '<span class="ai-pulse"></span> AI checking ' + escHtml(msg.value || '') + '...'; }
            }

            // Clear AI status when operation finishes or dialog closes
            if (msg.type === 'action-finished' || msg.type === 'close-preflight-dialog') {
                const el = document.getElementById('flow-ai-status');
                if (el) { el.innerHTML = ''; }
            }

            // Ensure loading-view is hidden when we get real data
            if (msg.type === 'update-stats' || msg.type === 'update-flow') {
                const lv = document.getElementById('loading-view');
                if (lv && lv.style.display !== 'none') { lv.style.display = 'none'; }
            }
        });

        vscode.postMessage({ type: 'get-flow' });
        setInterval(() => { if (flowEntries.length > 0) { renderFlowTab(flowEntries); } }, 30000);

    </script>

    <!-- Flow Tab Panel HTML ‚Äî inside main-view will be added via JS below -->
    <script>
        (function () {
            // Inject Flow tab panel into main-view after DOM ready
            const mainView = document.getElementById('main-view');
            if (mainView) {
                const flowDiv = document.createElement('div');
                flowDiv.id = 'flow';
                flowDiv.className = 'tab-content';
                flowDiv.innerHTML = '<div class="flow-header"><div class="flow-header-left"><span class="flow-header-title">&#9889; Flow &mdash; Session Log</span><span id="flow-ai-status"></span></div><button class="flow-clear-btn" id="flow-clear-btn">Clear</button></div><div id="flow-list"><div style="text-align:center;padding:40px 20px;color:var(--text-secondary);"><div style="font-size:2em;margin-bottom:12px;">&#9889;</div><div style="font-weight:600;margin-bottom:6px;">No operations yet</div><div style="font-size:11px;color:var(--text-secondary);">Git operations will appear here</div></div></div>';
                // Attach clear button event (can't use confirm() in VS Code webview)
                setTimeout(function () {
                    var clearBtn = document.getElementById('flow-clear-btn');
                    if (clearBtn) {
                        clearBtn.addEventListener('click', function () {
                            vscode.postMessage({ type: 'clear-flow' });
                        });
                    }
                }, 100);
                mainView.appendChild(flowDiv);
            }
        })();
    </script>

    <style>
        #flow {
            padding: 0;
        }

        .flow-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px 8px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-color);
            z-index: 5;
        }

        .flow-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flow-header-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
        }

        #flow-ai-status {
            font-size: 10px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 14px;
        }

        .ai-pulse {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1)
            }

            50% {
                opacity: 0.3;
                transform: scale(0.7)
            }
        }

        .flow-clear-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .flow-clear-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        #flow-list {
            padding: 8px 12px 20px;
        }

        .flow-date-group {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
            font-weight: 700;
            padding: 10px 0 4px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 6px;
        }

        .flow-entry {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
            border-left-width: 3px;
            background: var(--card-bg);
            transition: background 0.1s;
        }

        .flow-entry:hover {
            background: var(--hover-bg);
        }

        .flow-entry-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .flow-op-icon {
            font-size: 13px;
        }

        .flow-op-name {
            font-weight: 600;
            font-size: 12px;
            flex: 1;
        }

        .flow-entry-status {
            font-size: 13px;
        }

        .flow-entry-details {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 3px;
        }

        .flow-entry-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .flow-entry-error {
            margin-top: 4px;
            font-size: 10px;
            color: #f14c4c;
            font-family: monospace;
            background: rgba(241, 76, 76, 0.08);
            padding: 3px 6px;
            border-radius: 3px;
        }

        .flow-running {
            border-left-color: var(--accent);
        }

        .flow-success {
            border-left-color: #238636;
        }

        .flow-failed {
            border-left-color: #d73a49;
        }

        .flow-cancelled {
            border-left-color: var(--text-secondary);
        }

        .preflight-badge {
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: 600;
        }

        .preflight-pass {
            background: rgba(35, 134, 54, 0.15);
            color: #3fb950;
        }

        .preflight-warn {
            background: rgba(210, 153, 34, 0.15);
            color: #d29922;
        }
    </style>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         Custom AI Pre-flight Dialog Overlay
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <style>
        #preflight-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #preflight-overlay.pf-visible {
            display: flex;
        }

        #preflight-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.55);
            animation: slideUp 0.22s cubic-bezier(.22, .68, 0, 1.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(16px) scale(0.97);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #pf-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #pf-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        #pf-title {
            font-weight: 700;
            font-size: 13px;
            flex: 1;
        }

        #pf-provider {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--hover-bg);
            padding: 2px 7px;
            border-radius: 10px;
        }

        #pf-body {
            padding: 14px 16px;
        }

        .scan-steps {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .scan-step {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 5px 0;
            font-size: 12px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .scan-step.pf-active {
            color: var(--accent);
            font-weight: 600;
        }

        .scan-step.pf-done {
            color: #3fb950;
        }

        .scan-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--border-color);
            flex-shrink: 0;
            transition: background 0.25s;
        }

        .scan-step.pf-active .scan-dot {
            background: var(--accent);
            animation: pulse 0.9s infinite;
        }

        .scan-step.pf-done .scan-dot {
            background: #3fb950;
        }

        #pf-passed-view {
            display: none;
            text-align: center;
            padding: 10px 0 18px;
        }

        .pf-passed-icon {
            font-size: 38px;
            margin-bottom: 8px;
        }

        #pf-result {
            display: none;
        }

        #pf-summary {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pf-issue {
            background: var(--hover-bg);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--border-color);
        }

        .pf-issue.error {
            border-left-color: #d73a49;
        }

        .pf-issue.warning {
            border-left-color: #d29922;
        }

        .pf-issue.info {
            border-left-color: var(--accent);
        }

        .pf-issue-hdr {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }

        .pf-sev {
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .sev-error {
            background: rgba(215, 58, 73, .15);
            color: #f14c4c;
        }

        .sev-warning {
            background: rgba(210, 153, 34, .15);
            color: #d29922;
        }

        .sev-info {
            background: rgba(31, 111, 235, .15);
            color: #388bfd;
        }

        .pf-issue-title {
            font-weight: 600;
            font-size: 12px;
        }

        .pf-file {
            font-family: monospace;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .pf-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin: 4px 0;
            line-height: 1.4;
        }

        .pf-sol {
            font-size: 11px;
            color: #3fb950;
            display: flex;
            gap: 4px;
            align-items: flex-start;
        }

        #pf-timing {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        #pf-footer {
            padding: 12px 16px 14px;
            display: flex;
            gap: 8px;
        }

        .pfbtn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-size: 12.5px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
        }

        .pfbtn:hover {
            opacity: 0.86;
        }

        .pfbtn:active {
            transform: scale(0.97);
        }

        .pfbtn-proceed {
            background: #238636;
            color: #fff;
        }

        .pfbtn-danger {
            background: rgba(215, 58, 73, 0.18);
            color: #f14c4c;
            border: 1px solid rgba(215, 58, 73, 0.35);
        }

        .pfbtn-cancel {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .pfbtn-dismiss {
            background: var(--accent);
            color: #fff;
        }
    </style>

    <div id="preflight-overlay">
        <div id="preflight-card">
            <div id="pf-header">
                <span id="pf-icon">&#129302;</span>
                <span id="pf-title">AI Pre-flight Check</span>
                <span id="pf-provider"></span>
            </div>
            <div id="pf-body">
                <ul class="scan-steps" id="pf-scanning">
                    <li class="scan-step" id="ps-1"><span class="scan-dot"></span>Reading git status &amp; branch</li>
                    <li class="scan-step" id="ps-2"><span class="scan-dot"></span>Scanning changed files</li>
                    <li class="scan-step" id="ps-3"><span class="scan-dot"></span>Checking secrets &amp; .env files</li>
                    <li class="scan-step" id="ps-4"><span class="scan-dot"></span>Running AI code review</li>
                    <li class="scan-step" id="ps-5"><span class="scan-dot"></span>Generating recommendations</li>
                </ul>
                <div id="pf-passed-view">
                    <div class="pf-passed-icon">&#9989;</div>
                    <div style="font-weight:700;margin-bottom:5px;">All Checks Passed!</div>
                    <div id="pf-passed-msg" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;"></div>
                    <div style="font-size:11px;color:var(--text-secondary);">Proceeding automatically...</div>
                </div>
                <div id="pf-result">
                    <div id="pf-summary"></div>
                    <div id="pf-issues"></div>
                    <div id="pf-timing"></div>
                </div>
            </div>
            <div id="pf-footer" style="display:none;"></div>
        </div>
    </div>

    <script>
        (function () {
            var _scanIv = null;

            // Per-operation scan steps ‚Äî context-aware steps for each git operation
            var OP_STEPS = {
                'fast-push': [
                    'Staging &amp; scanning all changed files',
                    'Detecting .env files &amp; hardcoded secrets',
                    'Reviewing code quality &amp; debug artifacts',
                    'Analyzing branch &amp; push safety',
                    'Running AI deep code review'
                ],
                'push': [
                    'Reading committed changes',
                    'Checking for secrets in tracked files',
                    'Reviewing code quality',
                    'Analyzing branch push safety',
                    'Running AI review'
                ],
                'commit': [
                    'Reading staged changes',
                    'Checking for secrets &amp; credentials',
                    'Reviewing code quality',
                    'Verifying no large binary files',
                    'Running AI review'
                ],
                'merge': [
                    'Reading branch differences',
                    'Analyzing potential merge conflicts',
                    'Checking merge target branch safety',
                    'Reviewing change impact',
                    'Running AI merge analysis'
                ],
                'pull': [
                    'Checking local uncommitted changes',
                    'Detecting potential merge conflicts',
                    'Reviewing remote changes',
                    'Analyzing conflict risk',
                    'Running AI analysis'
                ],
                'stash': [
                    'Reading current working changes',
                    'Reviewing files to be stashed',
                    'Running AI quick review',
                    'Generating summary',
                    'Analysis complete'
                ],
                'rebase': [
                    'Reading local commit history',
                    'Checking if branch is shared/public',
                    'Analyzing rebase impact',
                    'Detecting history rewrite risks',
                    'Running AI safety check'
                ]
            };
            var DEFAULT_STEPS = [
                'Reading git status',
                'Scanning changed files',
                'Checking for issues',
                'Running AI review',
                'Generating report'
            ];

            function esc(s) {
                if (!s) { return ''; }
                return String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;');
            }

            function pfShow(op) {
                var steps = OP_STEPS[op] || DEFAULT_STEPS;
                document.getElementById('pf-title').textContent = 'AI Pre-flight: ' + op;
                document.getElementById('pf-provider').textContent = '';
                document.getElementById('pf-icon').innerHTML = '&#129302;';
                document.getElementById('pf-scanning').style.display = 'block';
                document.getElementById('pf-result').style.display = 'none';
                document.getElementById('pf-passed-view').style.display = 'none';
                document.getElementById('pf-footer').style.display = 'none';

                // Set step labels dynamically based on operation
                var stepIds = ['ps-1', 'ps-2', 'ps-3', 'ps-4', 'ps-5'];
                stepIds.forEach(function (id, i) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.className = 'scan-step';
                        el.innerHTML = '<span class="scan-dot"></span>' + (steps[i] || '');
                    }
                });

                var step = 0;
                function adv() {
                    if (step > 0 && step <= stepIds.length) {
                        var p = document.getElementById(stepIds[step - 1]);
                        if (p) { p.className = 'scan-step pf-done'; }
                    }
                    if (step < stepIds.length) {
                        var c = document.getElementById(stepIds[step]);
                        if (c) { c.className = 'scan-step pf-active'; }
                        step++;
                    }
                }
                adv();
                if (_scanIv) { clearInterval(_scanIv); }
                _scanIv = setInterval(adv, 720);
                document.getElementById('preflight-overlay').classList.add('pf-visible');
            }

            function pfShowResult(data) {
                if (_scanIv) { clearInterval(_scanIv); _scanIv = null; }
                // Mark all steps done
                ['ps-1', 'ps-2', 'ps-3', 'ps-4', 'ps-5'].forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) { el.className = 'scan-step pf-done'; }
                });
                if (!data || !data.result) { pfHide(); return; }

                var r = data.result;
                var provLabel = r.provider === 'copilot' ? '&#129302; GitHub Copilot'
                    : r.provider === 'gemini' ? '&#128302; Gemini AI'
                        : 'AI';
                document.getElementById('pf-provider').innerHTML = provLabel;
                document.getElementById('pf-scanning').style.display = 'none';
                var footer = document.getElementById('pf-footer');
                footer.style.display = 'flex';

                if (!r.issues || r.issues.length === 0) {
                    // All clear ‚Äî user must explicitly click Proceed (no auto-proceed)
                    document.getElementById('pf-icon').innerHTML = '&#9989;';
                    document.getElementById('pf-title').textContent = 'All Checks Passed';
                    document.getElementById('pf-passed-view').style.display = 'block';
                    document.getElementById('pf-passed-msg').textContent = r.summary || 'No issues found. Safe to proceed.';
                    footer.innerHTML =
                        '<button class="pfbtn pfbtn-cancel" onclick="window.pfRespond(false)">&#10006; Cancel</button>'
                        + '<button class="pfbtn pfbtn-dismiss" onclick="window.pfRespond(true)">&#10003; Proceed with Operation</button>';
                    return;
                }

                var errs = r.issues.filter(function (i) { return i.severity === 'error'; });
                var hasErr = errs.length > 0;
                document.getElementById('pf-icon').innerHTML = hasErr ? '&#9940;' : '&#9888;&#65039;';
                document.getElementById('pf-title').textContent = hasErr ? 'Issues Found ‚Äî Review Required' : 'Warnings Detected';
                document.getElementById('pf-result').style.display = 'block';
                document.getElementById('pf-summary').innerHTML =
                    '<span>' + (hasErr ? '&#10060;' : '&#9888;') + '</span>'
                    + '<span style="margin-left:5px">' + esc(r.summary) + '</span>';
                document.getElementById('pf-timing').textContent =
                    'Scanned in ' + (r.durationMs || 0) + 'ms ¬∑ ' + (r.provider === 'copilot' ? 'GitHub Copilot' : r.provider === 'gemini' ? 'Gemini AI' : 'AI');

                var issHtml = r.issues.map(function (issue) {
                    var sev = issue.severity || 'warning';
                    var sevTx = { error: '&#10006; Error', warning: '&#9888; Warning', info: '&#8505; Info' }[sev] || sev;
                    var fileStr = issue.file
                        ? '<div class="pf-file">' + esc(issue.file) + (issue.line ? ':' + issue.line : '') + '</div>'
                        : '';
                    return '<div class="pf-issue ' + sev + '">'
                        + '<div class="pf-issue-hdr">'
                        + '<span class="pf-sev sev-' + sev + '">' + sevTx + '</span>'
                        + '<span class="pf-issue-title">' + esc(issue.title) + '</span>'
                        + '</div>'
                        + fileStr
                        + '<div class="pf-desc">' + esc(issue.description) + '</div>'
                        + '<div class="pf-sol"><span>&#128161;</span><span>' + esc(issue.solution) + '</span></div>'
                        + '</div>';
                }).join('');
                document.getElementById('pf-issues').innerHTML = issHtml;

                if (hasErr) {
                    footer.innerHTML =
                        '<button class="pfbtn pfbtn-cancel" onclick="window.pfRespond(false)">&#10006; Cancel Operation</button>'
                        + '<button class="pfbtn pfbtn-danger" onclick="window.pfRespond(true)">Proceed Anyway</button>';
                } else {
                    footer.innerHTML =
                        '<button class="pfbtn pfbtn-cancel" onclick="window.pfRespond(false)">&#10006; Cancel</button>'
                        + '<button class="pfbtn pfbtn-proceed" onclick="window.pfRespond(true)">&#10003; Proceed</button>';
                }
            }

            function pfRespond(proceed) {
                pfHide();
                vscode.postMessage({ type: 'preflight-response', value: proceed ? 'proceed' : 'cancel' });
            }

            function pfHide() {
                if (_scanIv) { clearInterval(_scanIv); _scanIv = null; }
                var o = document.getElementById('preflight-overlay');
                if (o) { o.classList.remove('pf-visible'); }
            }

            window.pfRespond = pfRespond;
            window.pfHide = pfHide;

            window.addEventListener('message', function (evt) {
                var msg = evt.data;
                if (!msg) { return; }
                if (msg.type === 'ai-preflight-start') { pfShow(msg.value || 'operation'); }
                if (msg.type === 'show-preflight-dialog') { pfShowResult(msg.value); }
                if (msg.type === 'close-preflight-dialog') { pfHide(); }
                if (msg.type === 'ai-preflight-done' && msg.value && msg.value.skipped) { pfHide(); }
            });
        })();
    </script>

</body>

</html>